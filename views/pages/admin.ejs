        <div class="admin-page">
          <h2 class="admin-page__title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
          
          <!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
          <nav class="breadcrumbs" id="breadcrumbs">
            <a href="#" class="breadcrumb-link" onclick="showSection('type-selection'); return false;">–ê–¥–º–∏–Ω–∫–∞</a>
          </nav>

          <!-- –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è -->
          <div id="type-selection-tab" class="admin-tab-content active">
            <div class="admin-section">
              <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ –∑–∞–¥–∞–Ω–∏–π</h3>
              
              <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è -->
              <div id="edit-task-type-form" class="admin-form" style="display: none;">
                <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è</h4>
                <form id="task-type-form">
                  <input type="hidden" id="task-type-id" name="id" value="">
                  <div class="form-group">
                    <label for="task-type-title">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <input type="text" id="task-type-title" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è" required>
                  </div>
                  <div class="form-group">
                    <label for="task-type-description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea id="task-type-description" name="description" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="task-type-form-config">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ñ–æ—Ä–º—ã (JSON):</label>
                    <textarea id="task-type-form-config" name="form_config" rows="3" placeholder='{"fields": ["prompt", "context", "answer"]}'></textarea>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-secondary" onclick="cancelEditTaskType()">–û—Ç–º–µ–Ω–∞</button>
                  </div>
                </form>
              </div>
              
              <div class="task-types-grid" id="task-types-grid">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π...</p>
              </div>
            </div>
          </div>

          <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏ -->
          <div id="subtopics-tab" class="admin-tab-content" style="display: none;">
            <div class="admin-section">
              <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É –¥–ª—è —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è</h3>
              <form id="add-subtopic-form" class="admin-form">
                <input type="hidden" id="subtopic-type" name="type_id" value="">
                <div class="form-group">
                  <label for="subtopic-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã:</label>
                  <input type="text" id="subtopic-title" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã" required>
                </div>
                <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É</button>
              </form>
            </div>
        
            <div class="admin-section">
              <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ–º—ã</h3>
              <div id="subtopics-list" class="admin-list">
                <!-- –¢–µ–º—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
              </div>
            </div>
          </div>

          <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–µ–º ‚Ññ17 -->
          <div id="task17-tab" class="admin-tab-content" style="display: none;">
            <div class="admin-section">
              <h3>–ó–∞–¥–∞–Ω–∏–µ ‚Ññ17: –ü—É–Ω–∫—Ç—É–∞—Ü–∏—è</h3>
              <form id="task17-form" class="admin-form">
                <input type="hidden" id="task17-id" name="id" value="">
                
                <div class="form-group">
                  <label for="task17-source">–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
                  <select id="task17-source" name="source">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</option>
                    <option value="__new__">+ –ù–æ–≤—ã–π</option>
                    <!-- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                  </select>
                  <input type="text" id="task17-source-new" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞" style="display: none; margin-top: 8px;">
                  <small>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "+ –ù–æ–≤—ã–π" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</small>
                </div>
                
                <div class="form-group">
                  <label for="task17-text">–ó–∞–¥–∞–Ω–∏–µ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –º–µ—Ç–∫–∞–º–∏ (1), (2)...):</label>
                  <textarea id="task17-text" name="text" rows="3" placeholder="–í—ã—Å–æ–∫–∏–µ, —É–∑–∫–∏–µ –∫–ª–æ—á—å—è —Ç—É–º–∞–Ω–∞ (1) –≥—É—Å—Ç—ã–µ –∏ –±–µ–ª—ã–µ (2) –±—Ä–æ–¥–∏–ª–∏ –Ω–∞–¥ —Ä–µ–∫–æ–π (3) –∑–∞—Å–ª–æ–Ω—è—è (4) –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥ (5) –∏ (6) —Ü–µ–ø–ª—è—è—Å—å (7) –∑–∞ –∏–≤—ã." required></textarea>
                  <small>–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –º–µ—Ç–∫–∞–º–∏ —Ü–∏—Ñ—Ä –≤ –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –Ω—É–∂–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø—è—Ç—ã–µ</small>
                </div>

                <div class="form-group">
                  <label for="task17-answer">–û—Ç–≤–µ—Ç (—Ü–∏—Ñ—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –ø—Ä–æ–±–µ–ª):</label>
                  <input type="text" id="task17-answer" name="answer" placeholder="1,2,3,4,5,6,7" required>
                  <small>–ü–æ—Ä—è–¥–æ–∫ —Ü–∏—Ñ—Ä –Ω–µ –≤–∞–∂–µ–Ω. –ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏: 1,2,3,4,5,6,7 –∏–ª–∏ 1234567 –∏–ª–∏ 7 6 5 4 3 2 1</small>
                </div>

                <!-- –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (–∫–∞–∫ —É —É—á–µ–Ω–∏–∫–æ–≤) -->
                <div class="form-group" style="margin-top: 24px;">
                  <label style="margin-bottom: 12px; display: block;">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –∑–∞–ø—è—Ç—ã–º–∏ –≤–º–µ—Å—Ç–æ —Ü–∏—Ñ—Ä –∏–∑ –æ—Ç–≤–µ—Ç–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è):</label>
                  
                  <div style="display: flex; gap: 16px; align-items: flex-start;">
                    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –æ–±—ä—è—Å–Ω–µ–Ω–∏—è - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º (–∫–∞–∫ —É —É—á–µ–Ω–∏–∫–æ–≤) -->
                    <div style="flex: 1; position: relative;">
                      <div 
                        id="task17-explanation-editor" 
                        class="task17-explanation-editor" 
                        contenteditable="true" 
                        data-placeholder="–í—ã—Å–æ–∫–∏–µ, —É–∑–∫–∏–µ –∫–ª–æ—á—å—è —Ç—É–º–∞–Ω–∞ (1) –≥—É—Å—Ç—ã–µ –∏ –±–µ–ª—ã–µ (2) –±—Ä–æ–¥–∏–ª–∏ –Ω–∞–¥ —Ä–µ–∫–æ–π (3) –∑–∞—Å–ª–æ–Ω—è—è (4) –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –∑–≤—ë–∑–¥ (5) –∏ (6) —Ü–µ–ø–ª—è—è—Å—å (7) –∑–∞ –∏–≤—ã."
                        style="
                          min-height: 300px; 
                          padding: 20px; 
                          border: 1px solid var(--glass-border); 
                          border-radius: var(--radius-lg); 
                          background: var(--glass-bg);
                          backdrop-filter: var(--glass-backdrop);
                          -webkit-backdrop-filter: var(--glass-backdrop);
                          box-shadow: var(--shadow-glass);
                          color: var(--text-primary); 
                          font-family: inherit; 
                          font-size: 18px; 
                          line-height: 1.8;
                          white-space: pre-wrap;
                        "
                      ></div>
                      <textarea id="task17-explanation" name="explanation" style="display: none;"></textarea>
                      <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∑–∞–¥–∞–Ω–∏—è -->
                      <input type="hidden" id="task17-text" name="text">
                      
                    </div>
                    
                    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
                    <div class="task17-sidebar-toolbar" style="
                      width: 240px;
                      padding: 16px;
                      background: var(--bg-tertiary);
                      border-radius: var(--radius-lg);
                      border: 1px solid var(--glass-border);
                      position: sticky;
                      top: 20px;
                    ">
                      <div style="margin-bottom: 16px; color: var(--text-primary); font-weight: 600; font-size: 14px;">
                        –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω–∏—è
                      </div>
                      
                      <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                        <button type="button" class="btn btn-sm task17-toolbar-btn task17-toolbar-btn-participle" id="task17-mark-participle" style="width: 100%; justify-content: flex-start;">
                          <span style="text-decoration: underline wavy;">–ü—Ä–∏—á–∞—Å—Ç–Ω—ã–π</span>
                        </button>
                        <button type="button" class="btn btn-sm task17-toolbar-btn task17-toolbar-btn-gerund" id="task17-mark-gerund" style="width: 100%; justify-content: flex-start;">
                          –î–µ–µ–ø—Ä–∏—á–∞—Å—Ç–Ω—ã–π
                        </button>
                        <button type="button" class="btn btn-sm task17-toolbar-btn" id="task17-mark-main-word" style="width: 100%; justify-content: flex-start; border: 1px solid rgba(236, 72, 153, 0.5);">
                          ‚úï –ì–ª–∞–≤–Ω–æ–µ —Å–ª–æ–≤–æ
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary task17-toolbar-btn" id="task17-remove-mark" style="width: 100%; justify-content: flex-start;">
                          –£–±—Ä–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                        </button>
                      </div>
                      
                      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                        <div style="margin-bottom: 12px; color: var(--text-primary); font-weight: 600; font-size: 14px;">
                          –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" id="task17-link-turn" style="width: 100%; justify-content: flex-start;">
                          üé® –°–≤—è–∑–∞—Ç—å –æ–±–æ—Ä–æ—Ç —Å –≥–ª–∞–≤–Ω—ã–º —Å–ª–æ–≤–æ–º
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" id="task17-clear-colors" style="width: 100%; justify-content: flex-start; margin-top: 8px;">
                          üóë –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏
                        </button>
                        <small style="display: block; margin-top: 8px; color: var(--text-secondary); font-size: 11px; line-height: 1.4;">
                          –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ —Å–ª–æ–≤–æ, –∑–∞—Ç–µ–º –Ω–∞ –æ–±–æ—Ä–æ—Ç, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –∏—Ö —Ü–≤–µ—Ç–æ–º
                        </small>
                      </div>
                      
                      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border); font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                        <div style="margin-bottom: 8px;"><span class="span-participle" style="display: inline-block;">–ü—Ä–∏—á–∞—Å—Ç–Ω—ã–π ‚Äî –≤–æ–ª–Ω–∏—Å—Ç–∞—è –ª–∏–Ω–∏—è</span></div>
                        <div style="margin-bottom: 8px;"><span class="span-gerund" style="display: inline-block; position: relative; padding-bottom: 2px;">–î–µ–µ–ø—Ä–∏—á–∞—Å—Ç–Ω—ã–π ‚Äî —Ç–æ—á–∫–∞-—Ç–∏—Ä–µ</span></div>
                        <div><span class="span-main-word" style="display: inline-block; position: relative;">–ì–ª–∞–≤–Ω–æ–µ —Å–ª–æ–≤–æ ‚Äî –∫—Ä–µ—Å—Ç–∏–∫</span></div>
                      </div>
                    </div>
                  </div>
                  
                  <small style="display: block; margin-top: 12px;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–∑ –∑–∞–¥–∞–Ω–∏—è –≤—ã—à–µ. –†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –æ–±–æ—Ä–æ—Ç–æ–≤</small>
                </div>
                
                <div class="form-actions">
                  <button type="submit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
                  <button type="button" class="btn btn-secondary" onclick="resetTask17Form()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
              </form>
            </div>
            
            <div class="admin-section">
              <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞–Ω–∏—è ‚Ññ17</h3>
              <div id="task17-list" class="admin-list">
                <!-- –ó–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
              </div>
            </div>
          </div>

          <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏ -->
          <div id="assignments-tab" class="admin-tab-content" style="display: none;">
            <div class="admin-section">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 id="assignment-type-title" style="margin: 0;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
                <a href="#" class="admin-link-subtle" onclick="event.preventDefault(); switchToSubtopicsTab(); return false;" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏ (–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ)">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–∞–º–∏</a>
              </div>
              <form id="add-assignment-form" class="admin-form">
                <input type="hidden" id="assignment-id" name="id" value="">
                <div class="form-group">
                  <label for="assignment-fipi-number">–ù–æ–º–µ—Ä –§–ò–ü–ò (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                  <input type="text" id="assignment-fipi-number" name="fipi_number" placeholder="12345">
                </div>
                <div class="form-group">
                  <label for="assignment-source">–ò—Å—Ç–æ—á–Ω–∏–∫:</label>
                  <select id="assignment-source" name="source" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</option>
                    <option value="–§–ò–ü–ò">–§–ò–ü–ò</option>
                    <option value="–î—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫">–î—Ä—É–≥–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="assignment-prompt">–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞–Ω–∏—è:</label>
                  <div id="editor-prompt" class="editor-container"></div>
                  <textarea id="assignment-prompt" name="prompt" style="display: none;" required></textarea>
                </div>
                <div class="form-group">
                  <label for="assignment-subtopic">–¢–µ–º–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                  <select id="assignment-subtopic" name="subtopic_id">
                    <option value="">–ë–µ–∑ —Ç–µ–º—ã</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="assignment-context">–ö–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–¥–∞–Ω–∏—è):</label>
                  <div id="editor-context" class="editor-container editor-large"></div>
                  <textarea id="assignment-context" name="context" style="display: none;"></textarea>
                </div>
        <div class="form-group">
          <label for="assignment-answer">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</label>
          <input type="text" id="assignment-answer" name="answer" placeholder="–Ω–µ–≥–æ" required>
        </div>
        <div class="form-group">
          <label for="assignment-explanation">–û–±—ä—è—Å–Ω–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
          <div id="editor-explanation" class="editor-container"></div>
          <textarea id="assignment-explanation" name="explanation" style="display: none;"></textarea>
        </div>
        <div class="form-group">
          <label for="assignment-rule-ref">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∞–≤–∏–ª–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
          <input type="text" id="assignment-rule-ref" name="rule_ref" placeholder="¬ß 15.2">
        </div>
        <div class="form-group">
          <label for="assignment-alt-answers">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
          <input type="text" id="assignment-alt-answers" name="alt_answers" placeholder="–µ–≥–æ, –µ—ë, –∏—Ö">
        </div>
        <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
      </form>
    </div>

    <div class="admin-section">
      <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞–Ω–∏—è</h3>
      <div id="assignments-list" class="admin-list">
        <!-- –ó–∞–¥–∞–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
      </div>
    </div>
  </div>
</div>

<script>
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–∫—Ü–∏–π
  function showSection(sectionId) {
    // –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –≤—ã–±–æ—Ä—É —Ç–∏–ø–∞, –æ—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (sectionId === 'type-selection') {
      localStorage.removeItem('adminCurrentSection');
      localStorage.removeItem('adminSelectedType');
      window.selectedTaskType = null;
    } else {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–µ–∫—Ü–∏—é
      localStorage.setItem('adminCurrentSection', sectionId);
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.admin-tab-content').forEach(content => {
      content.style.display = 'none';
      content.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
    const section = document.getElementById(`${sectionId}-tab`);
    if (section) {
      section.style.display = 'block';
      section.classList.add('active');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–∫—Ü–∏–∏
      if (sectionId === 'type-selection') {
        loadTaskTypes();
        updateBreadcrumbs([]);
      } else if (sectionId === 'subtopics') {
        loadSubtopics();
      } else if (sectionId === 'assignments') {
        loadAssignments();
        loadSubtopicsForSelect('#assignment-subtopic');
        setTimeout(async () => {
          await ensureEditorsInitialized();
        }, 100);
      }
    }
  }
  window.showSection = showSection;

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫
  function updateBreadcrumbs(paths) {
    const breadcrumbs = document.getElementById('breadcrumbs');
    if (!breadcrumbs) return;
    
    breadcrumbs.innerHTML = '<a href="#" class="breadcrumb-link" onclick="showSection(\'type-selection\'); return false;">–ê–¥–º–∏–Ω–∫–∞</a>';
    
    paths.forEach((path, index) => {
      const separator = document.createElement('span');
      separator.className = 'breadcrumb-separator';
      separator.textContent = '‚Ä∫';
      breadcrumbs.appendChild(separator);
      
      if (path.action && index < paths.length - 1) {
        // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å –¥–µ–π—Å—Ç–≤–∏–µ–º
        const link = document.createElement('a');
        link.href = '#';
        link.className = 'breadcrumb-link';
        link.textContent = path.label;
        link.onclick = (e) => {
          e.preventDefault();
          if (path.action) {
            path.action();
          }
          return false;
        };
        breadcrumbs.appendChild(link);
      } else {
        // –¢–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç (–Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π)
        const span = document.createElement('span');
        span.className = 'breadcrumb-current';
        span.textContent = path.label;
        breadcrumbs.appendChild(span);
      }
    });
  }

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏

          // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
          async function loadTabData(tab) {
            if (tab === 'type-selection') {
              await loadTaskTypes();
            } else if (tab === 'subtopics') {
              await loadSubtopics();
            } else if (tab === 'assignments') {
              await loadAssignments();
              await loadSubtopicsForSelect('#assignment-subtopic');
              // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∑–∞–¥–∞–Ω–∏–π
              // –ñ–¥–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –≤–∫–ª–∞–¥–∫–∞ —Ç–æ—á–Ω–æ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π
              setTimeout(async () => {
                await ensureEditorsInitialized();
              }, 100);
            }
          }
          
          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
          async function ensureEditorsInitialized() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π –≤–∏–¥–∏–º–∞
            const assignmentsTab = document.getElementById('assignments-tab');
            if (!assignmentsTab || !assignmentsTab.classList.contains('active')) {
              return;
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (List –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω)
            const allRequiredPluginsLoaded = () => {
              return typeof EditorJS !== 'undefined' &&
                     typeof Header !== 'undefined' &&
                     typeof Paragraph !== 'undefined' &&
                     typeof Quote !== 'undefined' &&
                     typeof CodeTool !== 'undefined' &&
                     typeof Delimiter !== 'undefined' &&
                     typeof Marker !== 'undefined' &&
                     typeof InlineCode !== 'undefined';
            };
            
            if (!allRequiredPluginsLoaded()) {
              let attempts = 0;
              const maxAttempts = 50;
              while (attempts < maxAttempts && !allRequiredPluginsLoaded()) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
              }
              
              if (!allRequiredPluginsLoaded()) {
                console.error('–ù–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞–≥–∏–Ω—ã Editor.js –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback —Ä–µ–∂–∏–º.');
                enableFallbackMode();
                return;
              }
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
            initializeEditors();
          }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π
  async function loadTaskTypes() {
    try {
      const response = await fetch('/api/admin/task-types');
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const taskTypes = await response.json();
      
      const grid = document.getElementById('task-types-grid');
      if (taskTypes.length === 0) {
        grid.innerHTML = '<p>–¢–∏–ø—ã –∑–∞–¥–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
      }
      
      grid.innerHTML = taskTypes.map(type => `
        <div class="task-type-card" data-type-id="${type.id}">
          <div class="task-type-content" onclick="selectTaskType(${type.id}, '${type.title}')">
            <div class="task-type-number">${type.id}</div>
            <div class="task-type-title">${type.title}</div>
            <div class="task-type-description">${type.description}</div>
          </div>
          <div class="task-type-actions">
            <button class="btn btn-sm btn-secondary" onclick="editTaskType(${type.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      `).join('');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π:', error);
      const grid = document.getElementById('task-types-grid');
      grid.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p>';
    }
  }

          // –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
          function selectTaskType(typeId, typeTitle) {
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ17, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (typeId === 17) {
              showTask17Admin();
              return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø
            window.selectedTaskType = { id: typeId, title: typeTitle };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
            localStorage.setItem('adminSelectedType', JSON.stringify({ id: typeId, title: typeTitle }));
            localStorage.setItem('adminCurrentSection', 'assignments');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º type_id –¥–ª—è —Ñ–æ—Ä–º—ã —Ç–µ–º
            const subtopicTypeInput = document.getElementById('subtopic-type');
            if (subtopicTypeInput) subtopicTypeInput.value = typeId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞–¥–∞–Ω–∏–π
            const assignmentTypeTitle = document.getElementById('assignment-type-title');
            if (assignmentTypeTitle) {
              assignmentTypeTitle.textContent = `–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Ç–∏–ø–∞ ${typeId}: ${typeTitle}`;
            }
            
            const assignmentTypeInput = document.getElementById('assignment-type');
            if (assignmentTypeInput) assignmentTypeInput.value = typeId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∑–∞–¥–∞–Ω–∏–π
            showSection('assignments');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
            updateBreadcrumbs([
              { 
                label: `–¢–∏–ø ${typeId}: ${typeTitle}`,
                action: () => {
                  showSection('assignments');
                  updateBreadcrumbs([
                    { label: `–¢–∏–ø ${typeId}: ${typeTitle}` },
                    { label: '–ó–∞–¥–∞–Ω–∏—è' }
                  ]);
                }
              },
              { label: '–ó–∞–¥–∞–Ω–∏—è' }
            ]);
          }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º
  async function loadSubtopics() {
    try {
      const typeId = window.selectedTaskType ? window.selectedTaskType.id : null;
      const url = typeId ? `/api/admin/subtopics?typeId=${typeId}` : '/api/admin/subtopics';
      
      const response = await fetch(url);
      const subtopics = await response.json();
      
      const list = document.getElementById('subtopics-list');
      list.innerHTML = subtopics.map(subtopic => `
        <div class="admin-item">
          <div class="item-info">
            <strong>${subtopic.title}</strong>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteSubtopic(${subtopic.id})">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `).join('');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º:', error);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π
  async function loadAssignments() {
    try {
      const typeId = window.selectedTaskType ? window.selectedTaskType.id : null;
      const url = typeId ? `/api/admin/assignments?typeId=${typeId}` : '/api/admin/assignments';
      
      const response = await fetch(url);
      const assignments = await response.json();
      
      const list = document.getElementById('assignments-list');
      list.innerHTML = assignments.map(assignment => {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –¥–ª—è prompt
        let promptPreview = '';
        try {
          const promptData = typeof assignment.prompt === 'string' ? JSON.parse(assignment.prompt) : assignment.prompt;
          promptPreview = EditorRenderer.createPreview(promptData, 100);
        } catch (e) {
          promptPreview = assignment.prompt.substring(0, 100) + '...';
        }
        
        return `
        <div class="admin-item">
          <div class="item-info">
            <strong>ID ${assignment.id}:</strong> ${assignment.source} ${assignment.fipi_number ? `(–§–ò–ü–ò ‚Ññ${assignment.fipi_number})` : ''}
            ${assignment.subtopic_title ? `<br><small>–¢–µ–º–∞: ${assignment.subtopic_title}</small>` : ''}
            <br><small>–£—Å–ª–æ–≤–∏–µ: ${promptPreview}</small>
            <br><small>–û—Ç–≤–µ—Ç: ${assignment.answer}</small>
          </div>
          <div class="item-actions">
            <button class="btn btn-secondary btn-sm" onclick="window.open('/admin/assignment/${assignment.id}/edit', '_blank')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-danger btn-sm" onclick="deleteAssignment(${assignment.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;
      }).join('');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞
  async function loadSubtopicsForSelect(selector) {
    try {
      const typeId = window.selectedTaskType ? window.selectedTaskType.id : null;
      const url = typeId ? `/api/admin/subtopics?typeId=${typeId}` : '/api/admin/subtopics';
      
      const response = await fetch(url);
      const subtopics = await response.json();
      
      const select = document.querySelector(selector);
      if (select) {
        select.innerHTML = '<option value="">–ë–µ–∑ —Ç–µ–º—ã</option>' + 
          subtopics.map(subtopic => 
            `<option value="${subtopic.id}">${subtopic.title}</option>`
          ).join('');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞:', error);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞
  async function loadTaskTypesForSelect(selector) {
    try {
      const response = await fetch('/api/admin/task-types');
      const taskTypes = await response.json();
      
      const select = document.querySelector(selector);
      if (select) {
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è</option>' + 
          taskTypes.map(type => 
            `<option value="${type.id}">–¢–∏–ø ${type.id}: ${type.title}</option>`
          ).join('');
      } else {
        console.error('–°–µ–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:', selector);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏–π:', error);
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏–π –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞
  async function loadAssignmentsForSelect(selector) {
    try {
      const response = await fetch('/api/admin/assignments');
      const assignments = await response.json();
      
      const select = document.querySelector(selector);
      if (select) {
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</option>' + 
          assignments.map(assignment => 
            `<option value="${assignment.id}">${assignment.title}</option>`
          ).join('');
      } else {
        console.error('–°–µ–ª–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:', selector);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π:', error);
    }
  }

  // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
  async function submitForm(form, endpoint, successMessage, reloadFunction) {
    try {
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);
      
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        alert(successMessage);
        form.reset();
        if (reloadFunction) reloadFunction();
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
  document.getElementById('add-subtopic-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await submitForm(e.target, '/api/admin/subtopics', '–¢–µ–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', loadSubtopics);
  });

  document.getElementById('add-assignment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
    await saveEditorData();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    if (data.alt_answers) {
      data.alt_answers = data.alt_answers.split(',').map(s => s.trim()).filter(s => s);
    }
    
    const isEdit = data.id && data.id !== '';
    const url = isEdit ? `/api/admin/assignments/${data.id}` : '/api/admin/assignments';
    const method = isEdit ? 'PUT' : 'POST';
    const successMessage = isEdit ? '–ó–∞–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!' : '–ó–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!';
    
    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        alert(successMessage);
        e.target.reset();
        document.getElementById('assignment-id').value = '';
        resetFormToAddMode();
        loadAssignments();
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
    }
  });

  // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
  async function deleteItem(id, endpoint, successMessage, reloadFunction) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
      try {
        const response = await fetch(endpoint, { method: 'DELETE' });
        if (response.ok) {
          alert(successMessage);
          if (reloadFunction) reloadFunction();
        } else {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      }
    }
  }

  // –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è
  window.deleteSubtopic = (id) => deleteItem(id, `/api/admin/subtopics/${id}`, '–¢–µ–º–∞ —É–¥–∞–ª–µ–Ω–∞!', loadSubtopics);
  window.deleteAssignment = (id) => deleteItem(id, `/api/admin/assignments/${id}`, '–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!', loadAssignments);

  // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –∫ —Ä–µ–∂–∏–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  function resetFormToAddMode() {
    document.querySelector('#assignments-tab .admin-section h3').textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ';
    document.querySelector('#add-assignment-form button').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
    const selectedType = window.selectedTaskType;
    if (selectedType) {
      updateBreadcrumbs([
        { 
          label: `–¢–∏–ø ${selectedType.id}: ${selectedType.title}`,
          action: () => {
            showSection('assignments');
            updateBreadcrumbs([
              { label: `–¢–∏–ø ${selectedType.id}: ${selectedType.title}` },
              { label: '–ó–∞–¥–∞–Ω–∏—è' }
            ]);
          }
        },
        { label: '–ó–∞–¥–∞–Ω–∏—è' }
      ]);
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–º (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
  function switchToSubtopicsTab() {
    const selectedType = window.selectedTaskType;
    if (selectedType) {
      window.open(`/admin/subtopics/${selectedType.id}`, '_blank');
    }
  }
  window.switchToSubtopicsTab = switchToSubtopicsTab;

          // –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
          window.editTaskType = async function(id) {
            try {
              const response = await fetch(`/api/admin/task-types/${id}`);
              const taskType = await response.json();
              
              // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
              document.getElementById('task-type-id').value = taskType.id;
              document.getElementById('task-type-title').value = taskType.title;
              document.getElementById('task-type-description').value = taskType.description || '';
              document.getElementById('task-type-form-config').value = taskType.form_config || '';
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
              document.getElementById('edit-task-type-form').style.display = 'block';
              document.getElementById('task-type-form').scrollIntoView({ behavior: 'smooth' });
              
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è:', error);
              alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è');
            }
          };

          // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          window.cancelEditTaskType = function() {
            document.getElementById('edit-task-type-form').style.display = 'none';
            document.getElementById('task-type-form').reset();
          };

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è
          document.getElementById('task-type-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
              const formData = new FormData(e.target);
              const data = Object.fromEntries(formData);
              
              const response = await fetch(`/api/admin/task-types/${data.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
              });
              
              if (response.ok) {
                alert('–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω!');
                document.getElementById('edit-task-type-form').style.display = 'none';
                e.target.reset();
                loadTaskTypes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
              } else {
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è');
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞:', error);
              alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –∑–∞–¥–∞–Ω–∏—è');
            }
          });

          // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          async function restoreAdminState() {
            try {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              const savedSection = localStorage.getItem('adminCurrentSection');
              const savedType = localStorage.getItem('adminSelectedType');
              
              if (savedType && savedSection && savedSection !== 'type-selection') {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø
                const typeData = JSON.parse(savedType);
                window.selectedTaskType = typeData;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º type_id –¥–ª—è —Ñ–æ—Ä–º—ã —Ç–µ–º
                const subtopicTypeInput = document.getElementById('subtopic-type');
                if (subtopicTypeInput) subtopicTypeInput.value = typeData.id;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞–¥–∞–Ω–∏–π
                const assignmentTypeTitle = document.getElementById('assignment-type-title');
                if (assignmentTypeTitle) {
                  assignmentTypeTitle.textContent = `–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Ç–∏–ø–∞ ${typeData.id}: ${typeData.title}`;
                }
                
                const assignmentTypeInput = document.getElementById('assignment-type');
                if (assignmentTypeInput) assignmentTypeInput.value = typeData.id;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏
                if (savedSection === 'assignments') {
                  updateBreadcrumbs([
                    { 
                      label: `–¢–∏–ø ${typeData.id}: ${typeData.title}`,
                      action: () => {
                        showSection('assignments');
                        updateBreadcrumbs([
                          { label: `–¢–∏–ø ${typeData.id}: ${typeData.title}` },
                          { label: '–ó–∞–¥–∞–Ω–∏—è' }
                        ]);
                      }
                    },
                    { label: '–ó–∞–¥–∞–Ω–∏—è' }
                  ]);
                } else if (savedSection === 'subtopics') {
                  updateBreadcrumbs([
                    { 
                      label: `–¢–∏–ø ${typeData.id}: ${typeData.title}`,
                      action: () => {
                        showSection('subtopics');
                        updateBreadcrumbs([
                          { label: `–¢–∏–ø ${typeData.id}: ${typeData.title}` },
                          { label: '–¢–µ–º—ã' }
                        ]);
                      }
                    },
                    { label: '–¢–µ–º—ã' }
                  ]);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
                showSection(savedSection);
              } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
                showSection('type-selection');
                loadTaskTypes();
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
              // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é
              showSection('type-selection');
              loadTaskTypes();
            }
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          document.addEventListener('DOMContentLoaded', () => {
            restoreAdminState();
          });
</script>

<!-- Editor.js CDN - –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ -->
<script>
  // –§—É–Ω–∫—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
  function loadScript(src, expectedGlobal = null) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = () => {
        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        setTimeout(() => {
          if (expectedGlobal) {
            const varNames = Array.isArray(expectedGlobal) ? expectedGlobal : [expectedGlobal];
            const allFound = varNames.every(name => typeof window[name] !== 'undefined');
            
            if (!allFound && expectedGlobal === 'List') {
              // –î–ª—è List –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏
              if (typeof window.List === 'undefined' && typeof List !== 'undefined') {
                window.List = List;
              }
            }
          }
          resolve();
        }, 100);
      };
      script.onerror = () => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', src);
        reject(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${src}`));
      };
      document.head.appendChild(script);
    });
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã Editor.js –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
  (async () => {
    try {
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.31.0', 'EditorJS');
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/header@2.8.8', 'Header');
      // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å List (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–≥–∏–Ω)
      try {
        await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/list@2.0.8', 'List');
        await new Promise(resolve => setTimeout(resolve, 200));
        if (typeof List !== 'undefined' && typeof window.List === 'undefined') {
          window.List = List;
        }
      } catch (e) {
        // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π CDN
        try {
          await loadScript('https://unpkg.com/@editorjs/list@2.0.8', 'List');
          if (typeof List !== 'undefined' && typeof window.List === 'undefined') {
            window.List = List;
          }
        } catch (e2) {
          // List –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ
        }
      }
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.7', 'Paragraph');
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/quote@2.7.6', 'Quote');
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/code@2.9.3', 'CodeTool');
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/delimiter@1.4.2', 'Delimiter');
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/marker@1.4.0', 'Marker');
      await loadScript('https://cdn.jsdelivr.net/npm/@editorjs/inline-code@1.5.2', 'InlineCode');
      
      // –ï—Å–ª–∏ List –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π CDN
      if (typeof List === 'undefined' && typeof window.List === 'undefined') {
        try {
          await loadScript('https://unpkg.com/@editorjs/list@2.0.8', 'List');
        } catch (e) {
          // List –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ
        }
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
      window.editorJSReady = true;
      
      // –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(() => {
          if (window.onEditorJSLoad) {
            window.onEditorJSLoad();
          }
        }, 100);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Editor.js:', error);
      window.editorJSReady = false;
      if (window.onEditorJSError) {
        window.onEditorJSError(error);
      }
    }
  })();
</script>

<!-- Editor Renderer -->
<script src="/js/editor-renderer.js"></script>

<script>
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
  let editorPrompt = null;
  let editorContext = null;
  let editorExplanation = null;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
  function initializeEditors() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Editor.js –∏ –≤—Å–µ—Ö –ø–ª–∞–≥–∏–Ω–æ–≤
    if (typeof EditorJS === 'undefined') {
      console.error('EditorJS –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω!');
      enableFallbackMode();
      return;
    }
    
    const requiredPlugins = ['Header', 'Paragraph', 'Quote', 'CodeTool', 'Delimiter', 'Marker', 'InlineCode'];
    const missingPlugins = requiredPlugins.filter(plugin => typeof window[plugin] === 'undefined');
    
    if (missingPlugins.length > 0) {
      console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–≥–∏–Ω—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', missingPlugins);
      enableFallbackMode();
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    const promptEl = document.getElementById('editor-prompt');
    const contextEl = document.getElementById('editor-context');
    const explanationEl = document.getElementById('editor-explanation');
    
    if (!promptEl || !contextEl || !explanationEl) {
      console.error('–≠–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!');
      enableFallbackMode();
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–∞
    const assignmentsTab = document.getElementById('assignments-tab');
    if (!assignmentsTab || !assignmentsTab.classList.contains('active')) {
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const stylePrompt = window.getComputedStyle(promptEl);
    const styleContext = window.getComputedStyle(contextEl);
    const styleExplanation = window.getComputedStyle(explanationEl);
    
    if (stylePrompt.display === 'none' || styleContext.display === 'none' || styleExplanation.display === 'none') {
      return;
    }

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (editorPrompt) {
      try {
        editorPrompt.destroy();
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è
      }
      editorPrompt = null;
    }
    if (editorContext) {
      try {
        editorContext.destroy();
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è
      }
      editorContext = null;
    }
    if (editorExplanation) {
      try {
        editorExplanation.destroy();
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è
      }
      editorExplanation = null;
    }
    
    // –†–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏—è –∑–∞–¥–∞–Ω–∏—è
    try {
      editorPrompt = new EditorJS({
        holder: 'editor-prompt',
        placeholder: '–í–≤–µ–¥–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞–Ω–∏—è...',
        data: { blocks: [] },
        tools: {
          header: {
            class: Header,
            config: {
              placeholder: '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
              levels: [1, 2, 3, 4, 5, 6],
              defaultLevel: 3
            }
          },
          // –î–æ–±–∞–≤–ª—è–µ–º list —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
          ...(typeof window.List !== 'undefined' || typeof List !== 'undefined' ? {
            list: {
              class: (typeof window.List !== 'undefined' ? window.List : List),
              inlineToolbar: true,
              config: {
                defaultStyle: 'unordered'
              }
            }
          } : {}),
          paragraph: {
            class: Paragraph,
            inlineToolbar: true
          },
          quote: {
            class: Quote,
            inlineToolbar: true,
            shortcut: 'CMD+SHIFT+O',
            config: {
              quotePlaceholder: '–¶–∏—Ç–∞—Ç–∞',
              captionPlaceholder: '–ê–≤—Ç–æ—Ä —Ü–∏—Ç–∞—Ç—ã',
            }
          },
          code: {
            class: CodeTool,
            config: {
              placeholder: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥...'
            }
          },
          delimiter: Delimiter,
          marker: {
            class: Marker,
            shortcut: 'CMD+SHIFT+M'
          },
          inlineCode: {
            class: InlineCode,
            shortcut: 'CMD+SHIFT+C'
          }
        }
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ prompt:', error);
    }

    // –†–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    try {
      const ListClass = (typeof window.List !== 'undefined' ? window.List : (typeof List !== 'undefined' ? List : null));
      
      editorContext = new EditorJS({
      holder: 'editor-context',
      placeholder: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–¥–∞–Ω–∏—è...',
      data: { blocks: [] },
      tools: {
        header: {
          class: Header,
          config: {
            placeholder: '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
            levels: [1, 2, 3, 4, 5, 6],
            defaultLevel: 3
          }
        },
        // –î–æ–±–∞–≤–ª—è–µ–º list —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
        ...(ListClass ? {
          list: {
            class: ListClass,
            inlineToolbar: true,
            config: {
              defaultStyle: 'unordered'
            }
          }
        } : {}),
        paragraph: {
          class: Paragraph,
          inlineToolbar: true
        },
        quote: {
          class: Quote,
          inlineToolbar: true,
          shortcut: 'CMD+SHIFT+O',
          config: {
            quotePlaceholder: '–¶–∏—Ç–∞—Ç–∞',
            captionPlaceholder: '–ê–≤—Ç–æ—Ä —Ü–∏—Ç–∞—Ç—ã',
          }
        },
        code: {
          class: CodeTool,
          config: {
            placeholder: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥...'
          }
        },
        delimiter: Delimiter,
        marker: {
          class: Marker,
          shortcut: 'CMD+SHIFT+M'
        },
        inlineCode: {
          class: InlineCode,
          shortcut: 'CMD+SHIFT+C'
        }
      }
    });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ context:', error);
    }

    // –†–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
    try {
      const ListClass = (typeof window.List !== 'undefined' ? window.List : (typeof List !== 'undefined' ? List : null));
      
      editorExplanation = new EditorJS({
      holder: 'editor-explanation',
      placeholder: '–í–≤–µ–¥–∏—Ç–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞...',
      data: { blocks: [] },
      tools: {
        header: {
          class: Header,
          config: {
            placeholder: '–ó–∞–≥–æ–ª–æ–≤–æ–∫',
            levels: [1, 2, 3, 4, 5, 6],
            defaultLevel: 3
          }
        },
        // –î–æ–±–∞–≤–ª—è–µ–º list —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
        ...(ListClass ? {
          list: {
            class: ListClass,
            inlineToolbar: true,
            config: {
              defaultStyle: 'unordered'
            }
          }
        } : {}),
        paragraph: {
          class: Paragraph,
          inlineToolbar: true
        },
        quote: {
          class: Quote,
          inlineToolbar: true,
          shortcut: 'CMD+SHIFT+O',
          config: {
            quotePlaceholder: '–¶–∏—Ç–∞—Ç–∞',
            captionPlaceholder: '–ê–≤—Ç–æ—Ä —Ü–∏—Ç–∞—Ç—ã',
          }
        },
        code: {
          class: CodeTool,
          config: {
            placeholder: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥...'
          }
        },
        delimiter: Delimiter,
        marker: {
          class: Marker,
          shortcut: 'CMD+SHIFT+M'
        },
        inlineCode: {
          class: InlineCode,
          shortcut: 'CMD+SHIFT+C'
        }
      }
    });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ explanation:', error);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    if (!editorPrompt || !editorContext || !editorExplanation) {
      console.error('–ù–µ –≤—Å–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã:', {
        prompt: !!editorPrompt,
        context: !!editorContext,
        explanation: !!editorExplanation
      });
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ textarea
  async function saveEditorData() {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ–º –ª–∏ –º—ã –≤ fallback —Ä–µ–∂–∏–º–µ
      if (document.getElementById('assignment-prompt').style.display !== 'none') {
        return;
      }

      if (editorPrompt) {
        const promptData = await editorPrompt.save();
        document.getElementById('assignment-prompt').value = JSON.stringify(promptData);
      }
      
      if (editorContext) {
        const contextData = await editorContext.save();
        document.getElementById('assignment-context').value = JSON.stringify(contextData);
      }
      
      if (editorExplanation) {
        const explanationData = await editorExplanation.save();
        document.getElementById('assignment-explanation').value = JSON.stringify(explanationData);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:', error);
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–∑ JSON
  async function loadEditorData(promptJson, contextJson, explanationJson) {
    try {
      // –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç Editor.js
      const prepareData = (data) => {
        if (!data) return null;
        
        // –ï—Å–ª–∏ —É–∂–µ –æ–±—ä–µ–∫—Ç Editor.js
        if (typeof data === 'object' && data !== null && data.blocks && Array.isArray(data.blocks)) {
          return data;
        }
        
        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ - –ø—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
        if (typeof data === 'string') {
          if (data.trim().startsWith('{')) {
            try {
              const parsed = JSON.parse(data);
              if (parsed && parsed.blocks && Array.isArray(parsed.blocks)) {
                return parsed;
              }
            } catch (e) {
              // –ù–µ JSON, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
            }
          }
          // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç - —Å–æ–∑–¥–∞–µ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ
          return {
            blocks: [{
              type: 'paragraph',
              data: { text: data }
            }]
          };
        }
        
        return null;
      };
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º prompt
      if (editorPrompt) {
        const promptData = prepareData(promptJson);
        if (promptData) {
          await editorPrompt.render(promptData);
        }
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º context
      if (editorContext) {
        const contextData = prepareData(contextJson);
        if (contextData) {
          await editorContext.render(contextData);
        } else {
          // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
          await editorContext.render({ blocks: [] });
        }
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º explanation
      if (editorExplanation) {
        const explanationData = prepareData(explanationJson);
        if (explanationData) {
          await editorExplanation.render(explanationData);
        } else {
          // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
          await editorExplanation.render({ blocks: [] });
        }
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã:', error);
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (List –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω)
  const allPluginsLoaded = () => {
    return typeof EditorJS !== 'undefined' &&
           typeof Header !== 'undefined' &&
           typeof Paragraph !== 'undefined' &&
           typeof Quote !== 'undefined' &&
           typeof CodeTool !== 'undefined' &&
           typeof Delimiter !== 'undefined' &&
           typeof Marker !== 'undefined' &&
           typeof InlineCode !== 'undefined';
  };

  // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
  function checkAndInitEditors() {
    if (allPluginsLoaded()) {
      // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–¥–∞–Ω–∏–π —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
      const assignmentsTab = document.getElementById('assignments-tab');
      if (assignmentsTab && assignmentsTab.classList.contains('active')) {
        setTimeout(async () => {
          await ensureEditorsInitialized();
        }, 300);
      }
    } else {
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
      let checkCount = 0;
      const checkInterval = setInterval(() => {
        checkCount++;
        if (allPluginsLoaded()) {
          clearInterval(checkInterval);
          checkAndInitEditors();
        } else if (checkCount > 50) {
          console.error('Editor.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥');
          clearInterval(checkInterval);
          enableFallbackMode();
        }
      }, 100);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Editor.js
  window.onEditorJSLoad = checkAndInitEditors;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ Editor.js
  window.onEditorJSError = (error) => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Editor.js:', error);
    enableFallbackMode();
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', () => {
    // –ï—Å–ª–∏ Editor.js —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º
    if (window.editorJSReady) {
      checkAndInitEditors();
    } else {
      // –ò–Ω–∞—á–µ –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª
      let checkCount = 0;
      const checkInterval = setInterval(() => {
        checkCount++;
        if (window.editorJSReady && allPluginsLoaded()) {
          clearInterval(checkInterval);
          checkAndInitEditors();
        } else if (checkCount > 50) {
          console.error('Editor.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥');
          clearInterval(checkInterval);
          enableFallbackMode();
        }
      }, 100);
    }
  });

  // Fallback —Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ textarea
  function enableFallbackMode() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ textarea
    const promptTextarea = document.getElementById('assignment-prompt');
    const contextTextarea = document.getElementById('assignment-context');
    const explanationTextarea = document.getElementById('assignment-explanation');
    
    if (promptTextarea) {
      promptTextarea.style.display = 'block';
      promptTextarea.required = true;
    }
    if (contextTextarea) {
      contextTextarea.style.display = 'block';
    }
    if (explanationTextarea) {
      explanationTextarea.style.display = 'block';
    }
    
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
    const editorContainers = document.querySelectorAll('.editor-container');
    editorContainers.forEach(container => {
      container.style.display = 'none';
    });
  }

  // ===== –ö–ê–°–¢–û–ú–ù–´–ô DROPDOWN –í –°–¢–ò–õ–ï –°–ê–ô–¢–ê =====
  function initCustomDropdowns() {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ dropdown –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
      const select = dropdown.querySelector('select');
      if (select) {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º select –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
        const parent = dropdown.parentNode;
        if (parent) {
          parent.insertBefore(select, dropdown);
          select.style.position = '';
          select.style.opacity = '';
          select.style.pointerEvents = '';
          select.style.width = '';
          select.style.height = '';
          select.style.left = '';
          select.style.top = '';
          select.style.visibility = '';
          select.style.zIndex = '';
        }
        dropdown.remove();
      }
    });

    document.querySelectorAll('.admin-form select, .form-group select').forEach(select => {
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
      if (select.closest('.custom-dropdown')) return;

      // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É
      const wrapper = document.createElement('div');
      wrapper.className = 'custom-dropdown';
      select.parentNode.insertBefore(wrapper, select);
      
      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º select –≤ wrapper –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º
      wrapper.appendChild(select);
      select.style.position = 'absolute';
      select.style.opacity = '0';
      select.style.pointerEvents = 'none';
      select.style.width = '1px';
      select.style.height = '1px';
      select.style.left = '-9999px';
      select.style.top = '-9999px';
      select.style.visibility = 'hidden';
      select.style.zIndex = '-1';

      // –°–æ–∑–¥–∞–µ–º trigger
      const trigger = document.createElement('div');
      trigger.className = 'custom-dropdown__trigger';
      trigger.setAttribute('tabindex', '0');
      
      const triggerText = document.createElement('span');
      triggerText.className = 'custom-dropdown__trigger-text';
      trigger.appendChild(triggerText);
      
      const arrow = document.createElement('div');
      arrow.className = 'custom-dropdown__arrow';
      trigger.appendChild(arrow);
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º trigger –ü–ï–†–ï–î select –≤–Ω—É—Ç—Ä–∏ wrapper
      wrapper.insertBefore(trigger, select);
      
      // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ wrapper –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
      wrapper.style.position = 'relative';
      wrapper.style.zIndex = '10';

      // –°–æ–∑–¥–∞–µ–º –º–µ–Ω—é
      const menu = document.createElement('div');
      menu.className = 'custom-dropdown__menu';
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (–¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑) - –æ–±—ä—è–≤–ª—è–µ–º –∑–∞—Ä–∞–Ω–µ–µ
      let scrollHandler = null;
      let resizeHandler = null;
      let scrollUpdateScheduled = false;

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
      const positionMenu = (force = false) => {
        // –ï—Å–ª–∏ –º–µ–Ω—é –∑–∞–∫—Ä—ã—Ç–æ –∏ –Ω–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ - –Ω–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º
        if (!force && !menu.classList.contains('open')) return;
        const rect = trigger.getBoundingClientRect();
        // –î–ª—è position: fixed –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport, –±–µ–∑ —É—á–µ—Ç–∞ —Å–∫—Ä–æ–ª–ª–∞
        menu.style.top = (rect.bottom + 8) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.width = rect.width + 'px';
      };

      // Throttling –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
      const schedulePositionUpdate = () => {
        if (scrollUpdateScheduled) return;
        scrollUpdateScheduled = true;
        requestAnimationFrame(() => {
          if (menu.classList.contains('open')) {
            positionMenu();
          }
          scrollUpdateScheduled = false;
        });
      };

      // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é —Å –æ—á–∏—Å—Ç–∫–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      const closeMenu = () => {
        trigger.classList.remove('active');
        menu.classList.remove('open');
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        if (scrollHandler) {
          window.removeEventListener('scroll', scrollHandler, true);
          scrollHandler = null;
        }
        if (resizeHandler) {
          window.removeEventListener('resize', resizeHandler);
          resizeHandler = null;
        }
      };

      // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π
      const updateOptions = () => {
        menu.innerHTML = '';
        let hasSelected = false;
        
        Array.from(select.options).forEach((option, index) => {
          const menuOption = document.createElement('div');
          menuOption.className = 'custom-dropdown__option';
          menuOption.textContent = option.text;
          menuOption.dataset.value = option.value;
          
          if (option.value === '') {
            menuOption.classList.add('placeholder');
          }
          
          if (option.value === select.value) {
            menuOption.classList.add('selected');
            triggerText.textContent = option.text;
            triggerText.classList.toggle('placeholder', option.value === '');
            hasSelected = true;
          }
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º mousedown –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
          const handleSelection = (e) => {
            e.stopPropagation();
            e.preventDefault();
            e.cancelBubble = true;
            
            select.value = option.value;
            select.dispatchEvent(new Event('change', { bubbles: true }));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            menu.querySelectorAll('.custom-dropdown__option').forEach(opt => {
              opt.classList.remove('selected');
            });
            menuOption.classList.add('selected');
            
            triggerText.textContent = option.text;
            triggerText.classList.toggle('placeholder', option.value === '');
            closeMenu();
            
            trigger.blur();
            
            return false;
          };
          
          menuOption.addEventListener('mousedown', handleSelection);
          menuOption.addEventListener('click', handleSelection);
          
          menu.appendChild(menuOption);
        });
        
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –æ–ø—Ü–∏—é
        if (!hasSelected && select.options.length > 0) {
          triggerText.textContent = select.options[0].text;
          triggerText.classList.toggle('placeholder', select.options[0].value === '');
        }
      };
      
      updateOptions();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ body –¥–ª—è fixed –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      document.body.appendChild(menu);

      // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const isOpen = menu.classList.contains('open');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ dropdown
        document.querySelectorAll('.custom-dropdown__menu').forEach(m => {
          if (m !== menu) m.classList.remove('open');
        });
        document.querySelectorAll('.custom-dropdown__trigger').forEach(t => {
          if (t !== trigger) t.classList.remove('active');
        });
        
        if (isOpen) {
          closeMenu();
        } else {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –î–û –æ—Ç–∫—Ä—ã—Ç–∏—è, —á—Ç–æ–±—ã –º–µ–Ω—é —Å—Ä–∞–∑—É –ø–æ—è–≤–∏–ª–æ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–µ—Å—Ç–µ
          positionMenu(true);
          
          trigger.classList.add('active');
          menu.classList.add('open');
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –±—Ä–∞—É–∑–µ—Ä –ø—Ä–∏–º–µ–Ω–∏–ª —Å—Ç–∏–ª–∏ –∏ –º–µ–Ω—é —Å—Ç–∞–ª–æ –≤–∏–¥–∏–º—ã–º
          requestAnimationFrame(() => {
            positionMenu();
          });
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
          if (!scrollHandler) {
            scrollHandler = schedulePositionUpdate;
            window.addEventListener('scroll', scrollHandler, true);
          }
          if (!resizeHandler) {
            resizeHandler = schedulePositionUpdate;
            window.addEventListener('resize', resizeHandler);
          }
        }
        
        return false;
      });

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      let clickOutsideTimeout;
      const handleOutsideClick = (e) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –≤–Ω–µ wrapper –∏ –º–µ–Ω—é
        const clickedInside = wrapper.contains(e.target) || menu.contains(e.target) || trigger.contains(e.target);
        
        if (!clickedInside && menu.classList.contains('open')) {
          // –ó–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –∫–ª–∏–∫ –Ω–∞ –æ–ø—Ü–∏—é —É—Å–ø–µ–ª —Å—Ä–∞–±–æ—Ç–∞—Ç—å
          clearTimeout(clickOutsideTimeout);
          clickOutsideTimeout = setTimeout(() => {
            if (menu.classList.contains('open')) {
              closeMenu();
            }
          }, 150);
        }
      };
      
      document.addEventListener('mousedown', handleOutsideClick, false);
      document.addEventListener('click', handleOutsideClick, false);

      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeMenu();
        } else if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          trigger.click();
        }
      });

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ select –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
      select.addEventListener('change', () => {
        updateOptions();
      });
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ dropdown –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCustomDropdowns);
  } else {
    initCustomDropdowns();
  }

  // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
  const originalLoadSubtopicsForSelect = window.loadSubtopicsForSelect;
  if (originalLoadSubtopicsForSelect) {
    window.loadSubtopicsForSelect = async function(selector) {
      await originalLoadSubtopicsForSelect.call(this, selector);
      setTimeout(initCustomDropdowns, 100);
    };
  }

  // ===== –ó–ê–î–ê–ù–ò–ï ‚Ññ17 =====
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–¥–∞–Ω–∏—è ‚Ññ17
  function showTask17Admin() {
    showSection('task17');
    loadTask17Sources(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    loadTask17List(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π
    updateBreadcrumbs([
      { 
        label: '–¢–∏–ø 17: –ó–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö —Å–æ —Å–ª–æ–≤–∞–º–∏ –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏',
        action: () => {
          showTask17Admin();
        }
      },
      { label: '–ó–∞–¥–∞–Ω–∏–µ ‚Ññ17' }
    ]);
  }
  window.showTask17Admin = showTask17Admin;

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
  async function loadTask17Sources() {
    try {
      const response = await fetch('/api/sources');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const sources = await response.json();
      
      const select = document.getElementById('task17-source');
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      const currentValue = select.value;
      
      // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø—Ü–∏–∏ "–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫" –∏ "+ –ù–æ–≤—ã–π")
      const firstOption = select.querySelector('option[value=""]');
      const newOption = select.querySelector('option[value="__new__"]');
      
      select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</option><option value="__new__">+ –ù–æ–≤—ã–π</option>';
      
      sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source.name;
        option.textContent = source.name;
        select.appendChild(option);
      });
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
      if (currentValue && currentValue !== '__new__') {
        select.value = currentValue;
      } else if (currentValue === '__new__') {
        select.value = '__new__';
        handleTask17SourceChange(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:', error);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  function handleTask17SourceChange() {
    const select = document.getElementById('task17-source');
    const newInput = document.getElementById('task17-source-new');
    
    if (select.value === '__new__') {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
      newInput.style.display = 'block';
      newInput.value = '';
      newInput.focus();
    } else {
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
      newInput.style.display = 'none';
      newInput.value = '';
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è select –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      const select = document.getElementById('task17-source');
      if (select) {
        select.addEventListener('change', handleTask17SourceChange);
      }
    });
  } else {
    const select = document.getElementById('task17-source');
    if (select) {
      select.addEventListener('change', handleTask17SourceChange);
    }
  }


  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞–Ω–∏–π ‚Ññ17
  async function loadTask17List() {
    try {
      const response = await fetch('/api/task17');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const tasks = await response.json();
      
      const list = document.getElementById('task17-list');
      if (tasks.length === 0) {
        list.innerHTML = '<p>–ó–∞–¥–∞–Ω–∏—è ‚Ññ17 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
      }
      
      list.innerHTML = tasks.map(task => {
        const preview = task.source_text ? (task.source_text.substring(0, 100) + (task.source_text.length > 100 ? '...' : '')) : '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞';
        return `
          <div class="admin-list-item">
            <div class="admin-list-item-content">
              <div class="admin-list-item-title">–ó–∞–¥–∞–Ω–∏–µ #${task.id}</div>
              <div class="admin-list-item-description">${preview}</div>
              <div class="admin-list-item-meta">
                –°–æ–∑–¥–∞–Ω–æ: ${new Date(task.created_at).toLocaleString('ru-RU')}
              </div>
            </div>
            <div class="admin-list-item-actions">
              <button class="btn btn-sm" onclick="editTask17(${task.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button class="btn btn-sm btn-danger" onclick="deleteTask17(${task.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π ‚Ññ17:', error);
      const list = document.getElementById('task17-list');
      list.innerHTML = '<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π</p>';
    }
  }

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è ‚Ññ17
  async function editTask17(id) {
    try {
      const response = await fetch(`/api/task17/${id}`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const task = await response.json();
      
      document.getElementById('task17-id').value = task.id;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
      const sourceSelect = document.getElementById('task17-source');
      const newSourceInput = document.getElementById('task17-source-new');
      if (task.source) {
        sourceSelect.value = task.source;
        newSourceInput.style.display = 'none';
        newSourceInput.value = '';
      } else {
        sourceSelect.value = '';
        newSourceInput.style.display = 'none';
        newSourceInput.value = '';
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è
      document.getElementById('task17-text').value = task.source_text || '';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –∏–∑ digits
      const answerDigits = task.digits || [];
      document.getElementById('task17-answer').value = answerDigits.join(',');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π HTML
      const explanationEditor = document.getElementById('task17-explanation-editor');
      if (task.explanation_md) {
        explanationEditor.innerHTML = task.explanation_md;
      } else {
        // –ï—Å–ª–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∞
        updateExplanationFromTask();
      }
      
      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
      document.getElementById('task17-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è:', error);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏—è');
    }
  }
  window.editTask17 = editTask17;

  // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è ‚Ññ17
  async function deleteTask17(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ ‚Ññ17 #' + id + '?')) return;
    
    try {
      const response = await fetch(`/api/task17/${id}`, { method: 'DELETE' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      loadTask17List();
      alert('–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è:', error);
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
    }
  }
  window.deleteTask17 = deleteTask17;

  // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–¥–∞–Ω–∏—è ‚Ññ17
  function resetTask17Form() {
    document.getElementById('task17-form').reset();
    document.getElementById('task17-id').value = '';
    document.getElementById('task17-explanation-editor').innerHTML = '';
    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    document.getElementById('task17-source-new').style.display = 'none';
    document.getElementById('task17-source-new').value = '';
    // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
    const editor = document.getElementById('task17-explanation-editor');
    if (editor) {
      editor.innerHTML = '';
    }
  }
  window.resetTask17Form = resetTask17Form;

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∏–∑ –∑–∞–¥–∞–Ω–∏—è –∏ –æ—Ç–≤–µ—Ç–∞
  function updateExplanationFromTask() {
    const textInput = document.getElementById('task17-text');
    const answerInput = document.getElementById('task17-answer');
    const editor = document.getElementById('task17-explanation-editor');
    
    if (!textInput || !answerInput || !editor) return;
    
    const sourceText = textInput.value.trim();
    const answerText = answerInput.value.trim();
    
    if (!sourceText) {
      editor.innerHTML = '';
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è - –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
    const hasHighlights = editor.querySelectorAll('.span-participle, .span-gerund, .span-main-word').length > 0;
    if (hasHighlights && editor.textContent.trim() !== '') {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      return;
    }
    
    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç - –∏–∑–≤–ª–µ–∫–∞–µ–º —Ü–∏—Ñ—Ä—ã
    const answerDigits = answerText
      .split('')
      .map(char => parseInt(char, 10))
      .filter(n => !isNaN(n) && n > 0)
      .filter((value, index, self) => self.indexOf(value) === index);
    
    // –ü–∞—Ä—Å–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏ –∑–∞–º–µ–Ω—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∑–∞–ø—è—Ç—ã–µ –¥–ª—è —Ü–∏—Ñ—Ä –∏–∑ –æ—Ç–≤–µ—Ç–∞
    const regex = /\((\d+)\)/g;
    let result = sourceText;
    let match;
    const digitPositions = [];
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Ü–∏—Ñ—Ä
    while ((match = regex.exec(sourceText)) !== null) {
      const digit = parseInt(match[1], 10);
      digitPositions.push({
        index: match.index,
        length: match[0].length,
        digit: digit,
        shouldAddComma: answerDigits.includes(digit)
      });
    }
    
    // –ó–∞–º–µ–Ω—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∑–∞–ø—è—Ç—ã–µ (—Å –∫–æ–Ω—Ü–∞, —á—Ç–æ–±—ã –∏–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–¥–≤–∏–≥–∞–ª–∏—Å—å)
    for (let i = digitPositions.length - 1; i >= 0; i--) {
      const pos = digitPositions[i];
      const before = result.substring(0, pos.index);
      const after = result.substring(pos.index + pos.length);
      
      if (pos.shouldAddComma) {
        // –ó–∞–º–µ–Ω—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∑–∞–ø—è—Ç—É—é
        result = before + ',' + after;
      } else {
        // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É (–±–µ–∑ –∑–∞–ø—è—Ç–æ–π)
        result = before + after;
      }
    }
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç—ã—Ö
    result = result.replace(/,\s+/g, ', ');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    editor.textContent = result;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–∏—Ñ—Ä –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (–ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞) - —É—Å—Ç–∞—Ä–µ–≤—à–∞—è, –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  function formatDigitsInEditor() {
    const editor = document.getElementById('task17-explanation-editor');
    if (!editor) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–µ–∑ HTML
    const text = editor.innerText || editor.textContent || '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    const hasHighlights = editor.querySelectorAll('.span-participle, .span-gerund, .span-main-word').length > 0;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∏ (1), (2)..., —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–∏—Ñ—Ä—ã (–¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è)
    if (/\(\d+\)/.test(text)) {
      // –ü–∞—Ä—Å–∏–º —Ç–µ–∫—Å—Ç —Å –º–µ—Ç–∫–∞–º–∏ (1), (2)...
      const regex = /\((\d+)\)/g;
      const parts = [];
      let lastIndex = 0;
      let match;
      
      while ((match = regex.exec(text)) !== null) {
        if (match.index > lastIndex) {
          parts.push({ text: text.substring(lastIndex, match.index), digit: null });
        }
        const digitNum = parseInt(match[1], 10);
        parts.push({ text: match[0], digit: digitNum });
        lastIndex = match.index + match[0].length;
      }
      
      if (lastIndex < text.length) {
        parts.push({ text: text.substring(lastIndex), digit: null });
      }
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
      let html = '';
      parts.forEach((part, idx) => {
        if (part.digit !== null) {
          html += `<span class="task17-editor-digit" style="
            cursor: default;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 4px;
            display: inline-block;
            color: var(--neon-cyan);
            font-weight: 600;
            background: rgba(0, 240, 255, 0.1);
            border: 1px solid rgba(0, 240, 255, 0.3);
            user-select: none;
          ">${part.text}</span>`;
        } else {
          html += `<span>${part.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>`;
        }
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è - –µ—Å–ª–∏ –µ—Å—Ç—å, –Ω—É–∂–Ω–æ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
      if (hasHighlights) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è, –ø—ã—Ç–∞–µ–º—Å—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ü–∏—Ñ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã
        const existingDigits = editor.querySelectorAll('.task17-editor-digit');
        const allDigits = text.match(/\(\d+\)/g) || [];
        
        // –ï—Å–ª–∏ –Ω–µ –≤—Å–µ —Ü–∏—Ñ—Ä—ã –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Ö
        if (existingDigits.length < allDigits.length) {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
          const selection = window.getSelection();
          let cursorOffset = 0;
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(editor);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            cursorOffset = preCaretRange.toString().length;
          }
          
          // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ç–µ–∫—Å—Ç—É –∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–µ–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–∏—Ñ—Ä—ã
          const walker = document.createTreeWalker(
            editor,
            NodeFilter.SHOW_TEXT,
            null
          );
          
          let node;
          const nodesToProcess = [];
          while ((node = walker.nextNode())) {
            if (node.textContent.includes('(') && node.parentElement && !node.parentElement.classList.contains('task17-editor-digit')) {
              nodesToProcess.push(node);
            }
          }
          
          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É–∑–ª—ã
          nodesToProcess.forEach(node => {
            const parent = node.parentElement;
            const textContent = node.textContent;
            const regex = /\((\d+)\)/g;
            let match;
            let lastIndex = 0;
            const fragments = [];
            
            while ((match = regex.exec(textContent)) !== null) {
              if (match.index > lastIndex) {
                fragments.push(document.createTextNode(textContent.substring(lastIndex, match.index)));
              }
              
              const digitSpan = document.createElement('span');
              digitSpan.className = 'task17-editor-digit';
              digitSpan.textContent = match[0];
              fragments.push(digitSpan);
              
              lastIndex = match.index + match[0].length;
            }
            
            if (lastIndex < textContent.length) {
              fragments.push(document.createTextNode(textContent.substring(lastIndex)));
            }
            
            if (fragments.length > 0) {
              fragments.forEach(frag => parent.insertBefore(frag, node));
              parent.removeChild(node);
            }
          });
          
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
          if (cursorOffset > 0) {
            const walker2 = document.createTreeWalker(
              editor,
              NodeFilter.SHOW_TEXT,
              null
            );
            
            let currentOffset = 0;
            let node2;
            while ((node2 = walker2.nextNode())) {
              const nodeLength = node2.textContent.length;
              if (currentOffset + nodeLength >= cursorOffset) {
                const range = document.createRange();
                range.setStart(node2, cursorOffset - currentOffset);
                range.setEnd(node2, cursorOffset - currentOffset);
                selection.removeAllRanges();
                selection.addRange(range);
                break;
              }
              currentOffset += nodeLength;
            }
          }
        }
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω—è–µ–º HTML
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
        const selection = window.getSelection();
        let cursorOffset = 0;
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const preCaretRange = range.cloneRange();
          preCaretRange.selectNodeContents(editor);
          preCaretRange.setEnd(range.endContainer, range.endOffset);
          cursorOffset = preCaretRange.toString().length;
        }
        
        editor.innerHTML = html;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
        if (cursorOffset > 0) {
          const walker = document.createTreeWalker(
            editor,
            NodeFilter.SHOW_TEXT,
            null
          );
          
          let currentOffset = 0;
          let node;
          while ((node = walker.nextNode())) {
            const nodeLength = node.textContent.length;
            if (currentOffset + nodeLength >= cursorOffset) {
              const range = document.createRange();
              range.setStart(node, cursorOffset - currentOffset);
              range.setEnd(node, cursorOffset - currentOffset);
              selection.removeAllRanges();
              selection.addRange(range);
              break;
            }
            currentOffset += nodeLength;
          }
        }
      }
    }
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞
  const textInput = document.getElementById('task17-text');
  const answerInput = document.getElementById('task17-answer');
  
  if (textInput) {
    textInput.addEventListener('input', () => {
      setTimeout(updateExplanationFromTask, 100);
    });
    textInput.addEventListener('paste', () => {
      setTimeout(updateExplanationFromTask, 100);
    });
  }
  
  if (answerInput) {
    answerInput.addEventListener('input', () => {
      setTimeout(updateExplanationFromTask, 100);
    });
    answerInput.addEventListener('paste', () => {
      setTimeout(updateExplanationFromTask, 100);
    });
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞)
  if (textInput && answerInput && textInput.value && answerInput.value) {
    setTimeout(updateExplanationFromTask, 100);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –æ–±–æ—Ä–æ—Ç–æ–≤
  function initTask17SpanToolbar() {
    const editor = document.getElementById('task17-explanation-editor');
    const markParticipleBtn = document.getElementById('task17-mark-participle');
    const markGerundBtn = document.getElementById('task17-mark-gerund');
    const markMainWordBtn = document.getElementById('task17-mark-main-word');
    const removeMarkBtn = document.getElementById('task17-remove-mark');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª—è –∫ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤)
    function applySpanClass(className) {
      const selection = window.getSelection();
      if (selection.rangeCount === 0 || selection.toString().trim() === '') {
        alert('–í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏');
        return;
      }

      const range = selection.getRangeAt(0);
      
      if (range.collapsed) {
        alert('–í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –≤–µ—Å—å –¥–∏–∞–ø–∞–∑–æ–Ω –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–∞–Ω–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞
      const startContainer = range.startContainer;
      const endContainer = range.endContainer;
      
      // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å—Å–æ–º —Å–ø–∞–Ω–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è
      let startParent = startContainer.nodeType === 1 ? startContainer : startContainer.parentElement;
      while (startParent && startParent !== editor) {
        if (startParent.classList && startParent.classList.contains(className)) {
          // –í—ã–¥–µ–ª–µ–Ω–∏–µ —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–ø–∞–Ω–∞ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
          selection.removeAllRanges();
          editor.focus();
          return;
        }
        if (startParent.classList && (startParent.classList.contains('span-participle') || startParent.classList.contains('span-gerund') || startParent.classList.contains('span-main-word'))) {
          break; // –ù–∞–π–¥–µ–Ω —Å–ø–∞–Ω –¥—Ä—É–≥–æ–≥–æ —Ç–∏–ø–∞ - –º–æ–∂–Ω–æ –≤–ª–æ–∂–∏—Ç—å
        }
        startParent = startParent.parentElement;
      }
      
      // –ò—â–µ–º –¥–ª—è –∫–æ–Ω—Ü–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è
      let endParent = endContainer.nodeType === 1 ? endContainer : endContainer.parentElement;
      while (endParent && endParent !== editor) {
        if (endParent.classList && endParent.classList.contains(className)) {
          selection.removeAllRanges();
          editor.focus();
          return;
        }
        if (endParent.classList && (endParent.classList.contains('span-participle') || endParent.classList.contains('span-gerund') || endParent.classList.contains('span-main-word'))) {
          break;
        }
        endParent = endParent.parentElement;
      }

      // –ï—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–∞–Ω–∞ —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞, —É–¥–∞–ª—è–µ–º –µ–≥–æ
      const commonAncestor = range.commonAncestorContainer;
      let ancestorParent = commonAncestor.nodeType === 1 ? commonAncestor : commonAncestor.parentElement;
      
      while (ancestorParent && ancestorParent !== editor) {
        if (ancestorParent.classList && ancestorParent.classList.contains(className)) {
          // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–ø–∞–Ω —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
          const grandParent = ancestorParent.parentNode;
          while (ancestorParent.firstChild) {
            grandParent.insertBefore(ancestorParent.firstChild, ancestorParent);
          }
          grandParent.removeChild(ancestorParent);
          break;
        }
        ancestorParent = ancestorParent.parentElement;
      }

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π span —Å –Ω—É–∂–Ω—ã–º –∫–ª–∞—Å—Å–æ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–º)
      const span = document.createElement('span');
      span.className = className;
      
      try {
        range.surroundContents(span);
      } catch (e) {
        // –ï—Å–ª–∏ surroundContents –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤),
        // –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥
        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);
      }

      selection.removeAllRanges();
      editor.focus();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    markParticipleBtn.addEventListener('click', () => {
      applySpanClass('span-participle');
    });

    markGerundBtn.addEventListener('click', () => {
      applySpanClass('span-gerund');
    });

    markMainWordBtn.addEventListener('click', () => {
      applySpanClass('span-main-word');
    });

    removeMarkBtn.addEventListener('click', () => {
      const selection = window.getSelection();
      let range;
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
      } else {
        // –ï—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º range –≤ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
        range = document.createRange();
        if (selection.anchorNode) {
          try {
            range.setStart(selection.anchorNode, selection.anchorOffset);
            range.setEnd(selection.anchorNode, selection.anchorOffset);
          } catch (e) {
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å range, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
            const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT);
            let node;
            if (walker.nextNode()) {
              range.setStart(walker.currentNode, 0);
              range.setEnd(walker.currentNode, 0);
            } else {
              alert('–ü–æ–º–µ—Å—Ç–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –≤ —Ç–µ–∫—Å—Ç —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º');
              return;
            }
          }
        } else {
          alert('–ü–æ–º–µ—Å—Ç–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –≤ —Ç–µ–∫—Å—Ç —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º');
          return;
        }
      }
      
      const selectedParent = range.commonAncestorContainer;
      
      // –ò—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å –∫–ª–∞—Å—Å–æ–º span-*
      let parent = selectedParent.nodeType === 1 ? selectedParent : selectedParent.parentElement;
      let found = false;
      
      while (parent && parent !== editor) {
        if (parent.classList && (parent.classList.contains('span-participle') || parent.classList.contains('span-gerund') || parent.classList.contains('span-main-word'))) {
          const grandParent = parent.parentNode;
          while (parent.firstChild) {
            grandParent.insertBefore(parent.firstChild, parent);
          }
          grandParent.removeChild(parent);
          found = true;
          break;
        }
        parent = parent.parentElement;
      }

      if (!found) {
        alert('–ü–æ–º–µ—Å—Ç–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –≤ —Ç–µ–∫—Å—Ç —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º');
        return;
      }

      selection.removeAllRanges();
      editor.focus();
    });

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å —Å–∫—Ä—ã—Ç—ã–º textarea –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
    const form = document.getElementById('task17-form');
    form.addEventListener('submit', () => {
      const explanationHtml = editor.innerHTML;
      document.getElementById('task17-explanation').value = explanationHtml;
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
    initTask17ColorCoding();
  }
  
  // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≥–ª–∞–≤–Ω—ã—Ö —Å–ª–æ–≤ –∏ –æ–±–æ—Ä–æ—Ç–æ–≤
  function initTask17ColorCoding() {
    const editor = document.getElementById('task17-explanation-editor');
    const linkTurnBtn = document.getElementById('task17-link-turn');
    const clearColorsBtn = document.getElementById('task17-clear-colors');
    
    if (!editor || !linkTurnBtn || !clearColorsBtn) return;
    
    // –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≥–ª–∞–≤–Ω—ã—Ö —Å–ª–æ–≤
    const colorPalette = [
      { bg: 'rgba(59, 130, 246, 0.3)', border: 'rgba(59, 130, 246, 0.8)', text: 'rgba(59, 130, 246, 1)' }, // –°–∏–Ω–∏–π
      { bg: 'rgba(34, 197, 94, 0.3)', border: 'rgba(34, 197, 94, 0.8)', text: 'rgba(34, 197, 94, 1)' }, // –ó–µ–ª–µ–Ω—ã–π
      { bg: 'rgba(236, 72, 153, 0.3)', border: 'rgba(236, 72, 153, 0.8)', text: 'rgba(236, 72, 153, 1)' }, // –†–æ–∑–æ–≤—ã–π
      { bg: 'rgba(251, 191, 36, 0.3)', border: 'rgba(251, 191, 36, 0.8)', text: 'rgba(251, 191, 36, 1)' }, // –ñ–µ–ª—Ç—ã–π
      { bg: 'rgba(168, 85, 247, 0.3)', border: 'rgba(168, 85, 247, 0.8)', text: 'rgba(168, 85, 247, 1)' }, // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
      { bg: 'rgba(239, 68, 68, 0.3)', border: 'rgba(239, 68, 68, 0.8)', text: 'rgba(239, 68, 68, 1)' }, // –ö—Ä–∞—Å–Ω—ã–π
      { bg: 'rgba(14, 165, 233, 0.3)', border: 'rgba(14, 165, 233, 0.8)', text: 'rgba(14, 165, 233, 1)' }, // –ì–æ–ª—É–±–æ–π
      { bg: 'rgba(245, 158, 11, 0.3)', border: 'rgba(245, 158, 11, 0.8)', text: 'rgba(245, 158, 11, 1)' }, // –û—Ä–∞–Ω–∂–µ–≤—ã–π
    ];
    
    let isLinkingMode = false;
    let selectedMainWord = null;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —Å–ª–æ–≤–∞ (–ª–∏–±–æ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞, –ª–∏–±–æ –Ω–∞–∑–Ω–∞—á–∞–µ–º –Ω–æ–≤—ã–π)
    function getColorForMainWord(mainWord) {
      const colorId = mainWord.getAttribute('data-color-id');
      if (colorId !== null && colorId !== '') {
        const index = parseInt(colorId);
        return { index: index, color: colorPalette[index % colorPalette.length] };
      }
      // –ï—Å–ª–∏ —Ü–≤–µ—Ç–∞ –Ω–µ—Ç, –Ω–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π
      const usedColors = new Set();
      editor.querySelectorAll('.span-main-word[data-color-id]').forEach(el => {
        const id = el.getAttribute('data-color-id');
        if (id !== null && id !== '') {
          usedColors.add(parseInt(id));
        }
      });
      
      // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π –∏–Ω–¥–µ–∫—Å
      let freeIndex = 0;
      while (usedColors.has(freeIndex) && freeIndex < colorPalette.length) {
        freeIndex++;
      }
      
      return { index: freeIndex, color: colorPalette[freeIndex % colorPalette.length] };
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫ —ç–ª–µ–º–µ–Ω—Ç—É
    function applyColor(element, color) {
      element.style.backgroundColor = color.bg;
      element.style.borderColor = color.border;
      if (element.classList.contains('span-main-word')) {
        element.style.borderWidth = '2px';
        element.style.borderStyle = 'solid';
      } else {
        element.style.color = color.text;
      }
    }
    
    // –£–¥–∞–ª—è–µ–º —Ü–≤–µ—Ç —Å —ç–ª–µ–º–µ–Ω—Ç–∞
    function removeColor(element) {
      element.style.backgroundColor = '';
      element.style.borderColor = '';
      element.style.color = '';
      if (element.classList.contains('span-main-word')) {
        element.style.borderWidth = '';
        element.style.borderStyle = '';
      }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–≤–µ—Ç–∞ –∏–∑ HTML –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    function loadColorsFromHTML() {
      const mainWords = editor.querySelectorAll('.span-main-word[data-color-id]');
      mainWords.forEach(mainWord => {
        const colorId = parseInt(mainWord.getAttribute('data-color-id'));
        const color = colorPalette[colorId % colorPalette.length];
        applyColor(mainWord, color);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫–æ –≤—Å–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±–æ—Ä–æ—Ç–∞–º
        const linkedTurns = editor.querySelectorAll(`[data-linked-to="${mainWord.getAttribute('data-color-id')}"]`);
        linkedTurns.forEach(turn => {
          applyColor(turn, color);
        });
      });
    }
    
    // –°–≤—è–∑—ã–≤–∞–µ–º –æ–±–æ—Ä–æ—Ç —Å –≥–ª–∞–≤–Ω—ã–º —Å–ª–æ–≤–æ–º
    function linkTurnToMainWord(mainWord, turn) {
      // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —Å–ª–æ–≤–∞
      const colorData = getColorForMainWord(mainWord);
      const colorId = colorData.index;
      const color = colorData.color;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º color-id –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ —Å–ª–æ–≤–∞, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
      if (!mainWord.getAttribute('data-color-id')) {
        mainWord.setAttribute('data-color-id', colorId);
      }
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É —Å–ª–æ–≤—É
      applyColor(mainWord, color);
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∫ –æ–±–æ—Ä–æ—Ç—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑—å
      applyColor(turn, color);
      turn.setAttribute('data-linked-to', colorId);
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
    function clearAllColors() {
      // –£–¥–∞–ª—è–µ–º —Ü–≤–µ—Ç–∞ —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      editor.querySelectorAll('.span-main-word, .span-participle, .span-gerund').forEach(el => {
        removeColor(el);
        el.removeAttribute('data-color-id');
        el.removeAttribute('data-linked-to');
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–≤—è–∑–∞—Ç—å –æ–±–æ—Ä–æ—Ç —Å –≥–ª–∞–≤–Ω—ã–º —Å–ª–æ–≤–æ–º"
    linkTurnBtn.addEventListener('click', () => {
      isLinkingMode = !isLinkingMode;
      if (isLinkingMode) {
        linkTurnBtn.style.background = 'rgba(236, 72, 153, 0.3)';
        linkTurnBtn.style.borderColor = 'rgba(236, 72, 153, 0.8)';
        editor.style.cursor = 'pointer';
        selectedMainWord = null;
      } else {
        linkTurnBtn.style.background = '';
        linkTurnBtn.style.borderColor = '';
        editor.style.cursor = '';
        if (selectedMainWord) {
          selectedMainWord.style.outline = '';
        }
        selectedMainWord = null;
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–≤—è–∑–∏"
    clearColorsBtn.addEventListener('click', () => {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ü–≤–µ—Ç–æ–≤—ã–µ —Å–≤—è–∑–∏?')) {
        clearAllColors();
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
    editor.addEventListener('click', (e) => {
      if (!isLinkingMode) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const clickedElement = e.target.closest('.span-main-word, .span-participle, .span-gerund');
      if (!clickedElement) return;
      
      if (clickedElement.classList.contains('span-main-word')) {
        // –ö–ª–∏–∫ –ø–æ –≥–ª–∞–≤–Ω–æ–º—É —Å–ª–æ–≤—É - –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ
        if (selectedMainWord && selectedMainWord !== clickedElement) {
          selectedMainWord.style.outline = '';
        }
        selectedMainWord = clickedElement;
        selectedMainWord.style.outline = '3px solid rgba(236, 72, 153, 0.8)';
        selectedMainWord.style.outlineOffset = '2px';
      } else if (clickedElement.classList.contains('span-participle') || clickedElement.classList.contains('span-gerund')) {
        // –ö–ª–∏–∫ –ø–æ –æ–±–æ—Ä–æ—Ç—É - —Å–≤—è–∑—ã–≤–∞–µ–º —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≥–ª–∞–≤–Ω—ã–º —Å–ª–æ–≤–æ–º
        if (selectedMainWord) {
          linkTurnToMainWord(selectedMainWord, clickedElement);
          selectedMainWord.style.outline = '';
          selectedMainWord = null;
        } else {
          alert('–°–Ω–∞—á–∞–ª–∞ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ —Å–ª–æ–≤–æ');
        }
      }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const observer = new MutationObserver(() => {
      setTimeout(() => {
        loadColorsFromHTML();
      }, 100);
    });
    
    observer.observe(editor, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ['data-color-id', 'data-linked-to']
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(loadColorsFromHTML, 500);
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTask17SpanToolbar);
  } else {
    initTask17SpanToolbar();
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –∑–∞–¥–∞–Ω–∏—è ‚Ññ17
  document.getElementById('task17-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const explanationEditor = document.getElementById('task17-explanation-editor');
    const explanationHtml = explanationEditor.innerHTML;
    
    // –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ—Ä–µ–º –∏–∑ –ø–æ–ª—è task17-text (—Å –º–µ—Ç–∫–∞–º–∏), –∞ –Ω–µ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
    const textInput = document.getElementById('task17-text');
    const text = textInput ? textInput.value.trim() : '';
    
    if (!text) {
      alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –º–µ—Ç–∫–∞–º–∏ (1), (2)...');
      return;
    }
    
    const answerInput = document.getElementById('task17-answer').value.trim();
    
    // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
    const select = document.getElementById('task17-source');
    const newSourceInput = document.getElementById('task17-source-new');
    let source = select.value;
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "+ –ù–æ–≤—ã–π", –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (source === '__new__') {
      const newSourceName = newSourceInput.value.trim();
      if (!newSourceName) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
        return;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ –ë–î
      try {
        const response = await fetch('/api/sources', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newSourceName })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –≤—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
        await loadTask17Sources();
        source = newSourceName;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞: ' + error.message);
        return;
      }
    }
    
    if (!source || source.trim() === '' || source === '__new__') {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫');
      return;
    }
    
    // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç - –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–∂–¥—É—é –æ—Ç–¥–µ–ª—å–Ω—É—é —Ü–∏—Ñ—Ä—É –∏–∑ —Å—Ç—Ä–æ–∫–∏
    // –ù–∞–ø—Ä–∏–º–µ—Ä: "478" -> [4, 7, 8], "1,2,3" -> [1, 2, 3], "1 2 3" -> [1, 2, 3]
    const answerDigits = answerInput
      .split('') // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
      .map(char => parseInt(char, 10))
      .filter(n => !isNaN(n) && n > 0)
      .filter((value, index, self) => self.indexOf(value) === index); // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    
    if (answerDigits.length === 0) {
      alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É –≤ –æ—Ç–≤–µ—Ç–µ');
      return;
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º base_text –∏ commaless_text –∏–∑ source_text
    const baseText = text.replace(/\(\d+\)/g, '').trim();
    const commalessText = baseText.replace(/,/g, '');

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ —Ü–∏—Ñ—Ä—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    const allDigitsInText = [];
    const digitRegex = /\((\d+)\)/g;
    let match;
    while ((match = digitRegex.exec(text)) !== null) {
      allDigitsInText.push(parseInt(match[1], 10));
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∞–Ω—ã –∏–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è (–æ–±–æ—Ä–æ—Ç—ã —Å –∫–ª–∞—Å—Å–∞–º–∏ span-participle –∏ span-gerund)
    // –°–ø–∞–Ω—ã –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ HTML, –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤
    // –û–Ω–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–¥–∞–Ω–∏—è, —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    const formData = {
      source_text: text,
      base_text: baseText,
      commaless_text: commalessText,
      digits: answerDigits, // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
      comma_positions: [], // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
      spans: [], // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ - –æ–±–æ—Ä–æ—Ç—ã —Ç–æ–ª—å–∫–æ –≤ –æ–±—ä—è—Å–Ω–µ–Ω–∏–∏ (HTML)
      answer_text: null,
      explanation_md: explanationHtml,
      source: source,
      reveal_policy: 'after_correct'
    };
    
    const taskId = document.getElementById('task17-id').value;
    const url = taskId ? `/api/task17/${taskId}` : '/api/task17';
    const method = taskId ? 'PUT' : 'POST';
    
    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        const errorMessage = errorData.details ? `${errorData.error}: ${errorData.details}` : (errorData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        throw new Error(errorMessage);
      }
      
      const result = await response.json();
      alert(taskId ? '–ó–∞–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ' : '–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ (ID: ' + result.id + ')');
      
      resetTask17Form();
      loadTask17List();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è:', error);
      console.error('Form data:', formData);
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
  });
</script>
